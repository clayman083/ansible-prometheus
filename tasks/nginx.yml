---

- name: Prepare folders
  file: path={{ item }} state=directory
  with_items:
    - "{{ nginx.services_dir }}/prometheus"
    - /var/log/nginx/prometheus

- name: Assemble basic auth htpasswd
  htpasswd:
    path: "{{ nginx.conf_dir }}/prometheus.htpasswd"
    name: "{{ auth.user }}"
    password: "{{ auth.password }}"

- name: Assemble nginx config
  template: src="{{ item.src }}" dest="{{ item.dest }}"
  with_items:
    - src: nginx/consul-template.conf.j2
      dest: "{{ nginx.templates_dir }}/prometheus.conf"

- name: Assemble consul-template service config
  template:
    src: nginx/consul-template.service.j2
    dest: "{{ nginx.services_dir }}/prometheus/run"
    mode: 'u+x'
